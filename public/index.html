<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RUEDA – La pasta venezuelana che gira l’Italia</title>
  <link rel="stylesheet" href="stile.css"> <!-- Puoi separare gli stili se preferisci -->
</head>
<body>

  <header>
    <div class="lang-toggle">
      <button onclick="switchLanguage('it')">
        <img src="img/flag-it.png" alt="IT"> Italiano
      </button>
      <button onclick="switchLanguage('es')">
        <img src="img/flag-es.png" alt="ES"> Español
      </button>
    </div>
    <img src="img/logo-rueda.png" alt="RUEDA Logo" class="logo" />
    <p class="lang-it">La sfoglia venezuelana che gira l’Italia</p>
    <p class="lang-es" style="display: none;">La masa venezolana que rueda por Italia</p>

    <nav>
      <!-- Link multilingua -->
      <!-- ... -->
    </nav>
  </header>

  <section id="ordina">
    <h2 class="lang-it">Ordina i tuoi dischi RUEDA</h2>
    <form id="whatsappOrderForm" onsubmit="sendWhatsAppOrder(event)">
      <label>Nome</label>
      <input type="text" id="orderName" required />
      <label>Email</label>
      <input type="email" id="orderEmail" required />
      <label>Quantità</label>
      <select id="orderQty">
        <option value="6">6 dischi</option>
        <option value="12">12 dischi</option>
        <option value="30">30 dischi</option>
      </select>
      <button class="btn" type="submit">📱 Ordina via WhatsApp</button>
    </form>
  </section>

  <section id="testimonianze">
    <div class="lang-it">
      <h2>Cosa dicono i nostri clienti</h2>
      <div id="testimonialList"></div>

      <form id="testimonialForm" onsubmit="submitTestimonial(event)">
        <h3>Lascia una testimonianza</h3>
        <input type="text" id="testimonialName" placeholder="Il tuo nome" required disabled />
        <textarea id="testimonialText" placeholder="La tua esperienza RUEDA" required disabled></textarea>
        <textarea id="translation" placeholder="Traduzione (facoltativa)" disabled></textarea>
        <button type="submit" disabled>Invia</button>
      </form>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 RUEDA – Prodotto artigianale, 100% venezuelano, fatto in Italia</p>
  </footer>

  <!-- 🌐 Script con 'type="module"' per usare async/await -->
  <script type="module">
    const SCRIPT_URL = "/api/testimonianze";
    let hasOrdered = false;

    function switchLanguage(lang) {
      document.querySelectorAll('.lang-it').forEach(el => el.style.display = lang === 'it' ? 'block' : 'none');
      document.querySelectorAll('.lang-es').forEach(el => el.style.display = lang === 'es' ? 'block' : 'none');
    }

    function disableTestimonialForm() {
      const form = document.getElementById("testimonialForm");
      form.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);
    }

    function enableTestimonialForm() {
      const form = document.getElementById("testimonialForm");
      form.querySelectorAll("input, textarea, button").forEach(el => el.disabled = false);
    }

    function sendWhatsAppOrder(event) {
      event.preventDefault();
      const nome = document.getElementById('orderName').value.trim();
      const email = document.getElementById('orderEmail').value.trim();
      const qty = document.getElementById('orderQty').value;

      if (!nome || !email || qty < 1) {
        alert('Per favore compila tutti i campi.');
        return;
      }

      const message = `Ciao! Vorrei ordinare RUEDA.%0A📦 Quantità: ${qty}%0A👤 Nome: ${nome}%0A📧 Email: ${email}`;
      const phone = "393932760000";
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

      alert("Grazie per l'ordine! Ora puoi lasciare una recensione.");
      hasOrdered = true;
      enableTestimonialForm();
      window.open(url, '_blank');
    }

    async function submitTestimonial(event) {
      event.preventDefault();

      const nome = document.getElementById("testimonialName").value.trim();
      const recensione = document.getElementById("testimonialText").value.trim();
      const translation = document.getElementById("translation").value.trim();

      if (!nome || !recensione) {
        alert("Per favore, compila tutti i campi!");
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, recensione, translation })
        });

        if (res.ok) {
          alert("🎉 Grazie per la tua recensione! La pubblicheremo tra poco.");
          document.getElementById("testimonialForm").reset();
          loadTestimonials();
        } else {
          const errMsg = await res.text();
          console.error('Errore server:', errMsg);
          alert("⚠️ Errore durante l'invio: " + errMsg);
        }
      } catch (err) {
        console.error("🚨 Errore di rete:", err);
        alert("Errore di rete. Riprova più tardi.");
      }
    }

    function loadTestimonials() {
      fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("testimonialList");
          list.innerHTML = "";
          data.reverse().forEach(t => {
            const div = document.createElement("div");
            div.className = "testimonial";
            div.innerHTML = `<p><strong>${t.nome}</strong>: "${t.recensione}"</p>` +
              (t.translation ? `<p style="font-style: italic; color: #555;">${t.translation}</p>` : '');
            list.appendChild(div);
          });
        })
        .catch(() => {
          document.getElementById("testimonialList").innerHTML = "<p>Impossibile caricare le testimonianze.</p>";
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      switchLanguage('it');
      disableTestimonialForm();
      loadTestimonials();
    });
  </script>

</body>
</html>
